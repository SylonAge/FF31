<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karakter YÃ¶netimi Sistemi</title>
    <style>
        /* TEMEL STÄ°LLER */
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: #fff;
            --text-color: #333;
            --header-bg: #e9e9e9;
            --header-color: #555;
            --main-header-color: #007bff;
            --divider-color: #ccc;
            --dice-bg: #f0f0f0;
            --dice-border: #ccc;
            
            /* Ä°statistik Renkleri */
            --stat-str: #ff5733;
            --stat-con: #008080; /* Yeni DayanÄ±klÄ±lÄ±k rengi */
            --stat-bilgelik: #6a0572;
            --stat-dex: #008000;
            --stat-int: #007bff;
            --stat-cha: #ffd700;

            /* Ä°statistik Tint Renkleri */
            --stat-str-tint: rgba(255, 87, 51, 0.1);
            --stat-con-tint: rgba(0, 128, 128, 0.1); /* Yeni DayanÄ±klÄ±lÄ±k tint rengi */
            --stat-bilgelik-tint: rgba(106, 5, 114, 0.1); 
            --stat-dex-tint: rgba(0, 128, 0, 0.1);
            --stat-int-tint: rgba(0, 123, 255, 0.1);
            --stat-cha-tint: rgba(255, 215, 0, 0.1);

            /* HP/AC Renkleri */
            --hp-color: #28a745;
            --ac-color: #17a2b8;
            
            /* KAYIT/YÃœKLE BUTONLARI Ä°Ã‡Ä°N RENKLER */
            --save-button-bg: #28a745; 
            --load-button-bg: #ffc107;
            --reset-button-bg: #dc3545;
            --main-menu-bg: #6c757d; 
            --button-text-color: #fff;
        }

        /* GECE MODU */
        body.dark-mode {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #2a2a2a;
            --header-color: #bbbbbb;
            --main-header-color: #4da6ff;
            --divider-color: #333;
            --dice-bg: #222;
            --dice-border: #555;
            color: var(--text-color);
            --stat-str: #e95151; 
            --stat-con: #40e0d0; /* Yeni DayanÄ±klÄ±lÄ±k rengi (Koyu Mod) */
            --stat-bilgelik: #c175c9;
            --stat-dex: #77dd77;
            --stat-int: #4da6ff;
            --stat-cha: #fff380;
            --stat-str-tint: rgba(233, 81, 81, 0.15);
            --stat-con-tint: rgba(64, 224, 208, 0.15); /* Yeni DayanÄ±klÄ±lÄ±k tint rengi (Koyu Mod) */
            --stat-bilgelik-tint: rgba(193, 117, 201, 0.15);
            --stat-dex-tint: rgba(119, 221, 119, 0.15);
            --stat-int-tint: rgba(77, 166, 255, 0.15);
            --stat-cha-tint: rgba(255, 243, 128, 0.15);
            --save-button-bg: #1e7e34;
            --load-button-bg: #d39e00;
            --reset-button-bg: #c82333;
            --main-menu-bg: #495057;
        }

        body { font-family: Arial, sans-serif; background-color: var(--bg-primary); padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--bg-secondary); padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, box-shadow 0.3s; }
        h1 { text-align: center; color: var(--main-header-color); border-bottom: 2px solid var(--divider-color); padding-bottom: 10px; margin-bottom: 20px; }
        .section-title { background-color: var(--header-bg); padding: 8px; margin-top: 25px; margin-bottom: 15px; border-radius: 4px; font-weight: bold; color: var(--header-color); transition: background-color 0.3s, color 0.3s; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        /* GENEL INPUT VE TEXTAREA STÄ°LLERÄ° */
        input[type="text"], textarea, select { 
            width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--divider-color); 
            border-radius: 4px; box-sizing: border-box; background-color: var(--bg-secondary); color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        textarea { resize: vertical; }
        
        /* GRUPLAMA STÄ°LLERÄ° */
        .stat-group { display: flex; flex-wrap: wrap; gap: 20px; }
        .stat-item { flex: 1 1 calc(50% - 20px); min-width: 200px; padding: 10px; border-radius: 6px; border: 1px solid var(--divider-color); transition: border-color 0.3s, background-color 0.3s; }
        .stat-group.basic-info { gap: 15px; margin-bottom: 20px; }
        .stat-group.basic-info .stat-item { flex: 1 1 150px; min-width: 120px; padding: 0; border: none; }
        .stat-group.basic-info .stat-item input, .stat-group.basic-info .stat-item select { margin-bottom: 5px; }
        .stat-group.basic-info .full-width { flex: 1 1 100%; padding: 0; border: none; }
        /* 6 istatistik iÃ§in 3'lÃ¼ kolon stili gÃ¼ncellenmedi, otomatik daÄŸÄ±lÄ±m kullanÄ±lÄ±yor. */
        .stat-group.three-col .stat-item { flex: 1 1 calc(33.33% - 20px); min-width: 150px; padding: 10px; border: 1px solid var(--divider-color); }

        /* RENK STÄ°LLERÄ° */
        .stat-item.fiziksel_guc { border-left: 5px solid var(--stat-str); background-color: var(--stat-str-tint); }
        .stat-item.dayaniklilik { border-left: 5px solid var(--stat-con); background-color: var(--stat-con-tint); } /* Yeni DayanÄ±klÄ±lÄ±k stili */
        .stat-item.bilgelik { border-left: 5px solid var(--stat-bilgelik); background-color: var(--stat-bilgelik-tint); } 
        .stat-item.ceviklik { border-left: 5px solid var(--stat-dex); background-color: var(--stat-dex-tint); } 
        .stat-item.zeka { border-left: 5px solid var(--stat-int); background-color: var(--stat-int-tint); } 
        .stat-item.karizma { border-left: 5px solid var(--stat-cha); background-color: var(--stat-cha-tint); } 
        .stat-item.hp-box { border-left: 5px solid var(--hp-color); background-color: rgba(40, 167, 69, 0.1); }
        .stat-item.ac-box { border-left: 5px solid var(--ac-color); background-color: rgba(23, 162, 184, 0.1); }
        body.dark-mode .stat-item.hp-box { background-color: rgba(40, 167, 69, 0.2); }
        body.dark-mode .stat-item.ac-box { background-color: rgba(23, 162, 184, 0.2); }
        .race-bonus-text { font-size: 0.8em; color: var(--main-header-color); font-weight: normal; margin-left: 5px; cursor: pointer; }
        .race-bonus-text:hover { text-decoration: underline; }
        .value-bonus-group { display: flex; gap: 10px; }
        .value-input-container { flex: 2; display: flex; flex-direction: column; } 
        .bonus-input-container { flex: 1; display: flex; flex-direction: column; } 
        .value-bonus-group input { margin-bottom: 0; }
        .calculated-bonus { background-color: #fffae6; color: #e65100; transition: background-color 0.3s, color 0.3s; } 
        body.dark-mode .calculated-bonus { background-color: #4a3e26; color: #ffd700; }
        .priority-star { color: red; font-weight: bold; margin-left: 5px; }

        /* HP KONTROL STÄ°LLERÄ° */
        .hp-bar-container { width: 100%; height: 15px; background-color: var(--dice-border); border-radius: 4px; margin-top: -10px; margin-bottom: 5px; overflow: hidden; border: 1px solid var(--divider-color); }
        #hpBar { height: 100%; width: 100%; background-color: #4CAF50; transition: width 0.3s ease, background-color 0.3s ease; }
        .hp-control-group { display: flex; gap: 10px; margin-top: -10px; margin-bottom: 15px; }
        .rest-control-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .hp-control-group button, .rest-control-group button { flex: 1; padding: 8px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .hp-control-group #damageButton { background-color: #d93025; color: white; }
        .hp-control-group #healButton { background-color: #28a745; color: white; }
        .rest-control-group #shortRestButton { background-color: #ffc107; color: #333; }
        .rest-control-group #longRestButton { background-color: #17a2b8; color: white; }
        .hp-control-group input[type="text"] { flex: 1; margin-bottom: 0; text-align: center; }

        /* KAYIT / YÃœKLEME ALANI STÄ°LÄ° (SADECE YAPISAL SINIF KALDI) */
        .save-load-group { display: none; } /* Gizlendi */

        /* ZAR ATMA ALANI STÄ°LÄ° */
        .dice-roller { background-color: var(--dice-bg); padding: 15px; border: 2px solid var(--dice-border); border-radius: 6px; text-align: center; margin-top: 20px; margin-bottom: 20px; transition: background-color 0.3s, border-color 0.3s; }
        #rollButton, #baseAttackButton { background-color: var(--main-header-color); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 10px; min-width: 200px; }
        #rollButton:hover { background-color: #0056b3; }
        #baseAttackButton { background-color: #dc3545; }
        #baseAttackButton:hover { background-color: #c82333; }
        #diceResult { font-size: 2em; font-weight: bold; color: #d93025; margin-top: 10px; min-height: 1.2em; }
        
        /* YETENEK HAVUZU & RÃœTBE STÄ°LLERÄ° */
        .skills-section-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .skills-text-column {
            flex: 2 1 70%;
            min-width: 280px;
        }
        .ability-text-area small {
            margin-top: 5px;
            color: var(--text-color);
            display: block;
            font-size: 0.8em;
        }
        .ability-slot-panel {
            width: min(260px, 100%);
        }
        .skills-header-text h3 {
            margin: 0;
            font-size: 1.1em;
        }
        .skills-header-text p {
            margin: 4px 0;
        }
        .slot-instruction {
            color: var(--text-color);
            font-size: 0.85em;
        }
        .rank-bonus-text {
            margin: 5px 0;
            font-size: 0.9em;
            color: var(--main-header-color);
        }
        .ability-pool-slots {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ability-slot {
            border: 1px solid var(--divider-color);
            border-radius: 6px;
            padding: 10px;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .ability-slot-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 0.95em;
        }
        .ability-slot-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--main-header-color);
        }
        .ability-pool-input {
            width: 100%;
            min-height: 55px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--divider-color);
            background-color: var(--bg-primary);
            color: var(--text-color);
        }

        .multi-dice-panel {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        .dice-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dice-control label {
            font-weight: bold;
        }
        .dice-control input {
            width: 60px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--divider-color);
            background-color: var(--bg-secondary);
            color: var(--text-color);
        }
        .multi-dice-btn {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background-color: #6f42c1;
            color: white;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .multi-dice-btn:hover {
            background-color: #5a32a3;
        }

        /* YETENEK TABLOSU STÄ°LLERÄ° */
        .skills-items-layout { display: flex; gap: 30px; }
        .skills-table-container { flex: 0 0 40%; min-width: 300px; }
        .items-textarea-container { flex: 1 1 60%; }
        .skill-reference-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .skill-reference-table th, .skill-reference-table td { border: 1px solid var(--divider-color); padding: 8px; text-align: left; transition: border-color 0.3s; }
        .skill-reference-table th { background-color: #cce5ff; font-weight: bold; color: var(--text-color); transition: background-color 0.3s; }
        body.dark-mode .skill-reference-table th { background-color: #b38a00; color: #fff; } 
        body.dark-mode .skill-reference-table td:first-child { background-color: #2a2200; }
        body.dark-mode .skill-reference-table td a { color: white; }
        .skill-reference-table .skill-stat { font-weight: bold; color: #005c99; }
        body.dark-mode .skill-reference-table .skill-stat { color: #80bdff; }

        /* MODAL ZAR ATMA ANÄ°MASYON STÄ°LLERÄ° */
        #rollModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; flex-direction: column; cursor: pointer; }
        #modalResult { color: white; font-size: 4em; font-weight: bold; text-align: center; padding: 40px; border-radius: 10px; background: linear-gradient(45deg, #333, #555); box-shadow: 0 0 50px rgba(255, 255, 255, 0.3); min-width: 300px; transition: all 0.5s ease; }
        #modalTitle { color: #ccc; font-size: 1.5em; margin-bottom: 20px; }
        .modal-rolling { animation: shake 0.1s cubic-bezier(.36,.07,.19,.97) both infinite; text-shadow: 0 0 10px white; }

        /* YENÄ° MENÃœ VE KONTROL STÄ°LLERÄ° */
        #mainMenu { max-width: 600px; margin: 50px auto; padding: 40px; background-color: var(--bg-secondary); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: background-color 0.3s, color 0.3s; }
        .menu-button, .char-list-item button { width: 100%; padding: 12px; margin-bottom: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: bold; color: var(--button-text-color); transition: background-color 0.3s; }
        #newCharacterButton { background-color: var(--save-button-bg); }
        #newCharacterButton:hover { background-color: #1e7e34; }
        #goToCharacterListButton { background-color: var(--main-header-color); }
        #goToCharacterListButton:hover { background-color: #0056b3; }
        #characterListContainer { margin-top: 20px; }
        .char-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--divider-color); border-radius: 4px; margin-bottom: 10px; background-color: var(--header-bg); transition: background-color 0.3s, border-color 0.3s; }
        .char-list-item span { flex-grow: 1; font-weight: bold; color: var(--text-color); }
        .char-list-item button { width: 100px; margin-left: 10px; margin-bottom: 0; font-size: 0.9em; padding: 6px; }
        .char-list-item .load-btn { background-color: var(--load-button-bg); color: #333; }
        .char-list-item .delete-btn { background-color: var(--reset-button-bg); }
        #backToMenuButton { background-color: var(--main-menu-bg); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 15px; }
        #characterSheetContainer { display: none; }
        #darkModeToggle { position: absolute; top: 20px; right: 20px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background-color: #6c757d; color: white; }

        /* Responsive dÃ¼zenleme */
        @media (max-width: 900px) {
            .skills-items-layout { flex-direction: column; }
            .skills-table-container, .items-textarea-container { flex: 1 1 100%; min-width: initial; }
            .stat-group.three-col .stat-item { flex: 1 1 calc(50% - 20px); }
            .stat-group.basic-info { flex-direction: column; }
            .stat-group.basic-info .stat-item { min-width: 100%; }
            .save-load-group { flex-direction: column; }
        }
    </style>
</head>
<body>

<button id="darkModeToggle" onclick="toggleDarkMode()">ğŸŒ™ Gece Modu AÃ§</button>

<div id="rollModal">
    <div id="modalTitle"></div>
    <div id="modalResult">Zar AtÄ±lÄ±yor...</div>
    <p style="color: #ccc; margin-top: 30px;">Sonucu gÃ¶rmek ve kapatmak iÃ§in tÄ±klayÄ±n.</p>
</div>

<div id="mainMenu">
    <h1>Karakter YÃ¶netimi Ana MenÃ¼</h1>
    <p>LÃ¼tfen bir iÅŸlem seÃ§iniz:</p>
    
    <button id="newCharacterButton" onclick="showCharacterSheet(true)" class="menu-button">+ YENÄ° KARAKTER OLUÅTUR</button>
    <button id="goToCharacterListButton" onclick="showCharacterList()" class="menu-button">KAYITLI KARAKTERLERÄ° YÃœKLE / SÄ°L</button>

    <div id="characterListContainer" style="display: none;">
        <h3 style="margin-top: 20px;">KayÄ±tlÄ± Karakterler</h3>
        <ul id="charList" style="list-style: none; padding: 0;">
            </ul>
        <button onclick="showMainMenu()" class="menu-button" style="background-color: var(--main-menu-bg);">Ana MenÃ¼ye DÃ¶n</button>
    </div>
</div>

<div id="characterSheetContainer" class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button id="backToMenuButton" onclick="saveCurrentAndGoToMenu()">â—€ Ana MenÃ¼ye DÃ¶n & Kaydet</button>
        <h1>Karakter KaÄŸÄ±dÄ±</h1>
    </div>

    <div class="section-title">âœ¨ Temel Bilgiler</div>
    <div class="stat-group basic-info">
        <div class="stat-item"><label for="isim">Ä°SÄ°M</label><input type="text" id="isim" name="isim"></div>
        <div class="stat-item">
            <label for="sinif">SINIF</label>
            <select id="sinif" name="sinif" onchange="updateCharacterSheet()">
                <option value="">-- SeÃ§iniz --</option>
                </select>
        </div>
        <div class="stat-item">
            <label for="irk">IRK</label>
            <select id="irk" name="irk" onchange="updateCharacterSheet()">
                <option value="">-- SeÃ§iniz --</option>
                </select>
        </div>
        <div class="stat-item"><label for="yas">YAÅ</label><input type="text" id="yas" name="yas"></div>
        <div class="stat-item">
            <label for="rutbe">RÃœTBE</label>
            <select id="rutbe" name="rutbe">
                <option value="bronz" selected>Bronz</option>
                <option value="gumus">GÃ¼mÃ¼ÅŸ</option>
                <option value="altin">AltÄ±n</option>
                <option value="elmas">Elmas</option>
                <option value="platin">Platin</option>
            </select>
        </div>
        <div class="stat-item full-width">
            <small style="display: block; color: #1a73e8;">SÄ±nÄ±f/Irk kÄ±lavuzu iÃ§in <a href="sinif_kilavuzu.html" target="_blank">KÄ±lavuzu AÃ§</a>.</small>
        </div>
    </div>

    <div class="section-title">ğŸ“Š Ä°statistikler</div>
    <p style="margin-top: -10px; margin-bottom: 20px; font-style: italic;">Not: Irk bonuslarÄ± otomatik *eklenmez*. LÃ¼tfen istatistik deÄŸerlerine manuel ekleyiniz.</p>
    
    <div class="hp-armor-group stat-group">
        <div class="stat-item hp-box">
            <label for="can">CAN (Mevcut / Maks.)</label>
            <input type="text" id="can" name="can" placeholder="Ã–rn: 100 / 112" readonly>
            <div class="hp-bar-container">
                <div id="hpBar"></div>
            </div>
            </div>
        <div class="stat-item ac-box">
            <label for="zirh">ZIRH DEÄERÄ°</label>
            <input type="text" id="zirh" name="zirh" placeholder="Temel AC" readonly>
        </div>
    </div>

    <div class="hp-control-group full-width">
        <input type="text" id="hpValueInput" placeholder="DeÄŸer">
        <button id="damageButton">Hasar Al</button>
        <button id="healButton">Ä°yileÅŸtir</button>
    </div>

    <div class="rest-control-group full-width">
        <button id="shortRestButton">KÄ±sa Dinlenme (HP/2)</button>
        <button id="longRestButton">Uzun Dinlenme (Full HP)</button>
    </div>
    
    <div class="stat-group three-col">
        <div class="stat-item fiziksel_guc">
            <label>FÄ°ZÄ°KSEL GÃœÃ‡<span id="fiziksel_guc_race_bonus" class="race-bonus-text" onclick="applyRaceBonus('fiziksel_guc')"></span></label>
            <div class="value-bonus-group">
                <div class="value-input-container"><input type="text" id="fiziksel_guc_val" name="fiziksel_guc_val" placeholder="Temel Puan" oninput="calculateBonus('fiziksel_guc');" value="10"><label for="fiziksel_guc_val">DeÄŸer</label></div>
                <div class="bonus-input-container"><input type="text" id="fiziksel_guc_bonus" name="fiziksel_guc_bonus" placeholder="+0" readonly class="calculated-bonus"><label for="fiziksel_guc_bonus">Bonus</label></div>
            </div>
        </div>

        <div class="stat-item dayaniklilik">
            <label>DAYANIKLILIK<span id="dayaniklilik_race_bonus" class="race-bonus-text" onclick="applyRaceBonus('dayaniklilik')"></span></label>
            <div class="value-bonus-group">
                <div class="value-input-container"><input type="text" id="dayaniklilik_val" name="dayaniklilik_val" placeholder="Temel Puan" oninput="calculateBonus('dayaniklilik');" value="10"><label for="dayaniklilik_val">DeÄŸer</label></div>
                <div class="bonus-input-container"><input type="text" id="dayaniklilik_bonus" name="dayaniklilik_bonus" placeholder="+0" readonly class="calculated-bonus"><label for="dayaniklilik_bonus">Bonus</label></div>
            </div>
        </div>
        <div class="stat-item bilgelik">
            <label>BÄ°LGELÄ°K<span id="bilgelik_race_bonus" class="race-bonus-text" onclick="applyRaceBonus('bilgelik')"></span></label>
            <div class="value-bonus-group">
                <div class="value-input-container"><input type="text" id="bilgelik_val" name="bilgelik_val" placeholder="Temel Puan" oninput="calculateBonus('bilgelik');" value="10"><label for="bilgelik_val">DeÄŸer</label></div>
                <div class="bonus-input-container"><input type="text" id="bilgelik_bonus" name="bilgelik_bonus" placeholder="+0" readonly class="calculated-bonus"><label for="bilgelik_bonus">Bonus</label></div>
            </div>
        </div>
        
        <div class="stat-item ceviklik">
            <label>Ã‡EVÄ°KLÄ°K<span id="ceviklik_race_bonus" class="race-bonus-text" onclick="applyRaceBonus('ceviklik')"></span></label>
            <div class="value-bonus-group">
                <div class="value-input-container"><input type="text" id="ceviklik_val" name="ceviklik_val" placeholder="Temel Puan" oninput="calculateBonus('ceviklik');" value="10"><label for="ceviklik_val">DeÄŸer</label></div>
                <div class="bonus-input-container"><input type="text" id="ceviklik_bonus" name="ceviklik_bonus" placeholder="+0" readonly class="calculated-bonus"><label for="ceviklik_bonus">Bonus</label></div>
            </div>
        </div>
        
        <div class="stat-item zeka">
            <label>ZEKA<span id="zeka_race_bonus" class="race-bonus-text" onclick="applyRaceBonus('zeka')"></span></label>
            <div class="value-bonus-group">
                <div class="value-input-container"><input type="text" id="zeka_val" name="zeka_val" placeholder="Temel Puan" oninput="calculateBonus('zeka');" value="10"><label for="zeka_val">DeÄŸer</label></div>
                <div class="bonus-input-container"><input type="text" id="zeka_bonus" name="zeka_bonus" placeholder="+0" readonly class="calculated-bonus"><label for="zeka_bonus">Bonus</label></div>
            </div>
        </div>
        
        <div class="stat-item karizma">
            <label>KARÄ°ZMA<span id="karizma_race_bonus" class="race-bonus-text" onclick="applyRaceBonus('karizma')"></span></label>
            <div class="value-bonus-group">
                <div class="value-input-container"><input type="text" id="karizma_val" name="karizma_val" placeholder="Temel Puan" oninput="calculateBonus('karizma');" value="10"><label for="karizma_val">DeÄŸer</label></div>
                <div class="bonus-input-container"><input type="text" id="karizma_bonus" name="karizma_bonus" placeholder="+0" readonly class="calculated-bonus"><label for="karizma_bonus">Bonus</label></div>
            </div>
        </div>
    </div>
    
    <div class="dice-roller">
        <h3>Zar Atma AlanÄ± (D20 + Ã‡oklu Zar)</h3>
        <p>Beceri testleri iÃ§in 20 yÃ¼zlÃ¼ zarÄ± atÄ±n veya diÄŸer zar kombinasyonlarÄ±nÄ± kullanÄ±n.</p>
        <button id="rollButton">D20 ZAR AT</button>
        <button id="baseAttackButton" style="background-color: #dc3545; color: white;">TEMEL SALDIRI</button>
        <div class="multi-dice-panel">
            <div class="dice-control">
                <label for="diceCount-4">D4</label>
                <input type="number" id="diceCount-4" min="1" value="1">
                <button type="button" class="multi-dice-btn" data-dice="4">D4</button>
            </div>
            <div class="dice-control">
                <label for="diceCount-6">D6</label>
                <input type="number" id="diceCount-6" min="1" value="1">
                <button type="button" class="multi-dice-btn" data-dice="6">D6</button>
            </div>
            <div class="dice-control">
                <label for="diceCount-8">D8</label>
                <input type="number" id="diceCount-8" min="1" value="1">
                <button type="button" class="multi-dice-btn" data-dice="8">D8</button>
            </div>
            <div class="dice-control">
                <label for="diceCount-10">D10</label>
                <input type="number" id="diceCount-10" min="1" value="1">
                <button type="button" class="multi-dice-btn" data-dice="10">D10</button>
            </div>
            <div class="dice-control">
                <label for="diceCount-12">D12</label>
                <input type="number" id="diceCount-12" min="1" value="1">
                <button type="button" class="multi-dice-btn" data-dice="12">D12</button>
            </div>
            <div class="dice-control">
                <label for="diceCount-20">D20</label>
                <input type="number" id="diceCount-20" min="1" value="1">
                <button type="button" class="multi-dice-btn" data-dice="20">D20</button>
            </div>
        </div>
        <div id="diceResult">---</div>
    </div>
    
    <div class="section-title">âš”ï¸ Yetenekler ve EÅŸyalar</div>
    
    <div class="skills-items-layout">
        <div class="skills-table-container">
            <h3 style="margin-top: -10px;">Yetenek (Skill) HÄ±zlÄ± Referans</h3>
            <table class="skill-reference-table" id="skillReferenceTable">
                <thead>
                    <tr>
                        <th>Yetenek (Skill)</th>
                        <th style="width: 30%;">KullanÄ±lacak Ä°statistik</th>
                        <th style="width: 15%;">Bonus</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-stat-key="ceviklik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('ceviklik', 'Acrobatics (Akrobasi)')">Acrobatics (Akrobasi) ğŸ²</a></td><td class="skill-stat">Ã‡EVÄ°KLÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="bilgelik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('bilgelik', 'Animal Handling (Hayvan Ä°daresi)')">Animal Handling (Hayvan Ä°daresi) ğŸ²</a></td><td class="skill-stat">BÄ°LGELÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="zeka"><td><a href="javascript:void(0);" onclick="rollSkillCheck('zeka', 'Arcana (Gizem)')">Arcana (Gizem) ğŸ²</a></td><td class="skill-stat">ZEKA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="fiziksel_guc"><td><a href="javascript:void(0);" onclick="rollSkillCheck('fiziksel_guc', 'Athletics (Atletizm)')">Athletics (Atletizm) ğŸ²</a></td><td class="skill-stat">FÄ°ZÄ°KSEL GÃœÃ‡</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="karizma"><td><a href="javascript:void(0);" onclick="rollSkillCheck('karizma', 'Deception (KandÄ±rma)')">Deception (KandÄ±rma) ğŸ²</a></td><td class="skill-stat">KARÄ°ZMA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="zeka"><td><a href="javascript:void(0);" onclick="rollSkillCheck('zeka', 'History (Tarih)')">History (Tarih) ğŸ²</a></td><td class="skill-stat">ZEKA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="bilgelik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('bilgelik', 'Insight (Sezgi)')">Insight (Sezgi) ğŸ²</a></td><td class="skill-stat">BÄ°LGELÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="karizma"><td><a href="javascript:void(0);" onclick="rollSkillCheck('karizma', 'Intimidation (Korkutma)')">Intimidation (Korkutma) ğŸ²</a></td><td class="skill-stat">KARÄ°ZMA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="zeka"><td><a href="javascript:void(0);" onclick="rollSkillCheck('zeka', 'Investigation (AraÅŸtÄ±rma)')">Investigation (AraÅŸtÄ±rma) ğŸ²</a></td><td class="skill-stat">ZEKA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="bilgelik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('bilgelik', 'Medicine (TÄ±p)')">Medicine (TÄ±p) ğŸ²</a></td><td class="skill-stat">BÄ°LGELÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="zeka"><td><a href="javascript:void(0);" onclick="rollSkillCheck('zeka', 'Nature (DoÄŸa)')">Nature (DoÄŸa) ğŸ²</a></td><td class="skill-stat">ZEKA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="bilgelik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('bilgelik', 'Perception (AlgÄ±)')">Perception (AlgÄ±) ğŸ²</a></td><td class="skill-stat">BÄ°LGELÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="karizma"><td><a href="javascript:void(0);" onclick="rollSkillCheck('karizma', 'Performance (GÃ¶steri)')">Performance (GÃ¶steri) ğŸ²</a></td><td class="skill-stat">KARÄ°ZMA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="karizma"><td><a href="javascript:void(0);" onclick="rollSkillCheck('karizma', 'Persuasion (Ä°kna)')">Persuasion (Ä°kna) ğŸ²</a></td><td class="skill-stat">KARÄ°ZMA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="zeka"><td><a href="javascript:void(0);" onclick="rollSkillCheck('zeka', 'Religion (Din)')">Religion (Din) ğŸ²</a></td><td class="skill-stat">ZEKA</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="ceviklik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('ceviklik', 'Sleight of Hand (El Ã‡abukluÄŸu)')">Sleight of Hand (El Ã‡abukluÄŸu) ğŸ²</a></td><td class="skill-stat">Ã‡EVÄ°KLÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="ceviklik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('ceviklik', 'Stealth (Gizlenme)')">Stealth (Gizlenme) ğŸ²</a></td><td class="skill-stat">Ã‡EVÄ°KLÄ°K</td><td class="skill-bonus"></td></tr>
                    <tr data-stat-key="bilgelik"><td><a href="javascript:void(0);" onclick="rollSkillCheck('bilgelik', 'Survival (Hayatta Kalma)')">Survival (Hayatta Kalma) ğŸ²</a></td><td class="skill-stat">BÄ°LGELÄ°K</td><td class="skill-bonus"></td></tr>
                </tbody>
            </table>
        </div>

        <div class="items-textarea-container">
            <div class="skills-section-wrapper">
                <div class="skills-text-column">
                    <div class="stat-item full-width ability-text-area">
                        <label for="yetenekler">YETENEKLER / BÃœYÃœLER</label>
                        <textarea id="yetenekler" name="yetenekler" rows="8" placeholder="Aktif bÃ¼yÃ¼lerinizi ya da yeteneklerinizi buraya not alabilirsiniz..."></textarea>
                    </div>
                </div>
                <div class="ability-slot-panel">
                    <div class="skills-header-text">
                        <h3>BÃ¼yÃ¼ SlotlarÄ±</h3>
                        <p class="rank-bonus-text" id="rankDiceBonusLabel">Bronz rÃ¼tbesi tÃ¼m zaralara +0 bonus verir ve 1 yetenek slotu sunar.</p>
                    </div>
                    <div id="abilityPoolSlots" class="ability-pool-slots"></div>
                </div>
            </div>
            <div class="stat-group">
                <div class="stat-item full-width"><label for="pasif_yetenekler">PASÄ°F YETENEKLER</label><textarea id="pasif_yetenekler" name="pasif_yetenekler" rows="8" placeholder="Pasif yeteneklerinizi ve etkilerini buraya yazÄ±n..."></textarea></div>
                <div class="stat-item full-width"><label for="itemler">ITEMLER</label><textarea id="itemler" name="itemler" rows="10" placeholder="Envanterinizdeki eÅŸyalarÄ± listeleyin..."></textarea></div>
            </div>
        </div>
    </div>

    <p style="text-align: center; margin-top: 30px;">Bu form, **FRP** karakterinizi oluÅŸturmanÄ±z iÃ§in tasarlanmÄ±ÅŸtÄ±r. @SylonAge</p>
</div> 

<script>
    // KARAKTER VERÄ°LERÄ°
    const CLASS_HP = {
        "Barbarian (Barbar)": 130, "Fighter (SavaÅŸÃ§Ä±)": 125, "Paladin (Paladin)": 120,
        "Cleric (Ruhban)": 115, "Ranger (BekÃ§i)": 115, "Monk (KeÅŸiÅŸ)": 110,
        "Rogue (HÄ±rsÄ±z)": 110, "Bard (Ozan)": 105, "Druid (Druid)": 105,
        "Warlock (BÃ¼yÃ¼cÃ¼)": 105, "Sorcerer (BÃ¼yÃ¼cÃ¼)": 100, "Wizard (BÃ¼yÃ¼cÃ¼)": 100
    };
    
    const CLASS_BASE_AC = {
        "Barbarian (Barbar)": 15, "Fighter (SavaÅŸÃ§Ä±)": 15, "Paladin (Paladin)": 15,
        "Cleric (Ruhban)": 14, "Ranger (BekÃ§i)": 14, 
        "Monk (KeÅŸiÅŸ)": 13, "Rogue (HÄ±rsÄ±z)": 13, "Bard (Ozan)": 13, "Druid (Druid)": 13,
        "Warlock (BÃ¼yÃ¼cÃ¼)": 12, "Sorcerer (BÃ¼yÃ¼cÃ¼)": 12, "Wizard (BÃ¼yÃ¼cÃ¼)": 12
    };

    const RACE_STAT_BONUSES = {
        "Ä°nsan": { stats: { 'fiziksel_guc': 1, 'dayaniklilik': 1, 'bilgelik': 1, 'ceviklik': 1, 'zeka': 1, 'karizma': 1 }, ac: 0, hp: 0 },
        "Elf": { stats: { 'ceviklik': 2, 'zeka': 1 }, ac: 0, hp: 0 },
        "CÃ¼ce": { hp: 5, ac: 1, stats: { 'fiziksel_guc': 2, 'dayaniklilik': 2, 'bilgelik': 1 }, ac: 1, hp: 5 }, // DayanÄ±klÄ±lÄ±k eklendi
        "YarÄ±-Elf": { stats: { 'karizma': 2 } }, 
        "Ejderha Soyu": { stats: { 'fiziksel_guc': 2, 'karizma': 1 }, ac: 0, hp: 5 },
        "YarÄ±-Ork": { stats: { 'fiziksel_guc': 2, 'dayaniklilik': 1, 'bilgelik': 1 }, ac: 0, hp: 10 }, // DayanÄ±klÄ±lÄ±k eklendi
        "Gnome": { stats: { 'zeka': 2, 'ceviklik': 1 }, ac: 0, hp: 0 },
        "BuÃ§ukluk": { stats: { 'ceviklik': 2, 'karizma': 1 }, ac: 0, hp: 0 },
        "Tiefling": { stats: { 'zeka': 1, 'karizma': 2 }, ac: 0, hp: 0 }
    };
    
    // SÃ–ZDÄ°ZÄ°MÄ° HATASI GÄ°DERÄ°LDÄ°
    const CLASS_PRIORITIES = {
        "Barbarian (Barbar)": "fiziksel_guc", 
        "Fighter (SavaÅŸÃ§Ä±)": "fiziksel_guc", 
        "Paladin (Paladin)": "karizma", 
        "Cleric (Ruhban)": "bilgelik", 
        "Monk (KeÅŸiÅŸ)": "ceviklik",
        "Ranger (BekÃ§i)": "ceviklik", 
        "Rogue (HÄ±rsÄ±z)": "ceviklik", 
        "Bard (Ozan)": "karizma", 
        "Druid (Druid)": "bilgelik", 
        "Warlock (BÃ¼yÃ¼cÃ¼)": "karizma", 
        "Sorcerer (BÃ¼yÃ¼cÃ¼)": "karizma", 
        "Wizard (BÃ¼yÃ¼cÃ¼)": "zeka" 
    };

    const ALL_STATS_KEYS = ['fiziksel_guc', 'dayaniklilik', 'bilgelik', 'ceviklik', 'zeka', 'karizma']; 

    const RANK_SETTINGS = {
        bronz: { label: 'Bronz', diceBonus: 0, abilitySlots: 1 },
        gumus: { label: 'GÃ¼mÃ¼ÅŸ', diceBonus: 1, abilitySlots: 2 },
        altin: { label: 'AltÄ±n', diceBonus: 2, abilitySlots: 3 },
        elmas: { label: 'Elmas', diceBonus: 3, abilitySlots: 4 },
        platin: { label: 'Platin', diceBonus: 4, abilitySlots: 5 }
    };
    const DEFAULT_RANK_KEY = 'bronz';
    
    // Ã‡OKLU KAYIT Ä°Ã‡Ä°N YENÄ° ANAHTARLAR
    const LOCAL_STORAGE_KEY = 'frp_character_list'; 
    let currentCharacterName = ''; 
    let raceBonusAppliedState = {};
    ALL_STATS_KEYS.forEach(key => raceBonusAppliedState[key] = false);


    // --- YARDIMCI FONKSÄ°YONLAR ---

    function getCharacterList() {
        const listJson = localStorage.getItem(LOCAL_STORAGE_KEY);
        return listJson ? JSON.parse(listJson) : [];
    }

    function setCharacterList(list) {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(list));
    }

    function getCharacterDataKey(name) {
        // Ä°simdeki boÅŸluklarÄ± ve kÃ¼Ã§Ã¼k harfleri kullanarak benzersiz bir anahtar oluÅŸturur
        return `frp_char_${name.replace(/\s+/g, '_').toLowerCase()}`;
    }

    // --- EKRAN YÃ–NETÄ°MÄ° ---

    function showMainMenu() {
        document.getElementById('mainMenu').style.display = 'block';
        document.getElementById('characterSheetContainer').style.display = 'none';
        document.getElementById('characterListContainer').style.display = 'none';
    }

    function showCharacterSheet(isNew) {
        if (isNew) {
            // Yeni karakter oluÅŸturuluyorsa, tÃ¼m alanlarÄ± temizle
            resetCharacterSheetData(); 
            currentCharacterName = '';
            // Ä°sim inputunu da temizle
            document.getElementById('isim').value = '';
        }

        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('characterSheetContainer').style.display = 'block';
        
        updateCharacterSheet(); 
    }

    function showCharacterList() {
        document.getElementById('mainMenu').style.display = 'block';
        document.getElementById('characterSheetContainer').style.display = 'none';
        document.getElementById('characterListContainer').style.display = 'block';
        renderCharacterList();
    }

    function saveCurrentAndGoToMenu() {
        // MenÃ¼ye dÃ¶nmeden Ã¶nce otomatik kaydetme
        saveCharacterData(true); // Parametre true: Geri dÃ¶nÃ¼ldÃ¼ÄŸÃ¼ iÃ§in kaydet
        showMainMenu();
    }

    // --- TEMÄ°ZLEME/SIFIRLAMA ---

    function resetCharacterSheetData() {
        const formElements = document.querySelectorAll('#characterSheetContainer input, #characterSheetContainer select, #characterSheetContainer textarea');
        formElements.forEach(element => {
            if (!element.id || element.id === 'hpValueInput') {
                return;
            }

            if (element.type === 'checkbox') {
                element.checked = false;
            } else if (element.tagName === 'SELECT') {
                element.selectedIndex = 0;
            } else if (element.id.endsWith('_val')) {
                element.value = '10'; // Stat deÄŸerlerini varsayÄ±lan 10'a ayarla
            } else {
                element.value = '';
            }
        });

        document.getElementById('zirh').value = '---';
        document.getElementById('can').value = '--- / ---';
        document.getElementById('diceResult').textContent = '---';
        
        ALL_STATS_KEYS.forEach(statKey => {
            document.getElementById(statKey + '_bonus').value = '+0';
            raceBonusAppliedState[statKey] = false; 
        });
        clearPriorityStars();
        updateRaceBonusDisplay('');
        updateHPBar(0, 0); 
        updateRankDependentFields();
    }

    // --- CRUD Ä°ÅLEMLERÄ° ---

    // Kaydetme fonksiyonu gÃ¼ncellendi (ArtÄ±k menÃ¼ye dÃ¶nerken otomatik kaydediyor)
    function saveCharacterData(isAutoSave = false) {
        const name = document.getElementById('isim').value.trim();
        if (!name) {
            if (!isAutoSave) {
                alert("LÃ¼tfen karakterinize bir isim verin.");
            }
            return;
        }

        const characterData = {};
        const formElements = document.querySelectorAll('#characterSheetContainer input, #characterSheetContainer select, #characterSheetContainer textarea');

        formElements.forEach(element => {
            if (element.id && element.id !== 'hpValueInput') {
                if (element.type === 'checkbox') {
                    characterData[element.id] = element.checked;
                } else {
                    characterData[element.id] = element.value;
                }
            }
        });
        characterData['raceBonusAppliedState'] = raceBonusAppliedState;

        const dataKey = getCharacterDataKey(name);

        try {
            // Ana Listeyi GÃ¼ncelle
            let list = getCharacterList();
            if (!list.includes(name)) {
                list.push(name);
                setCharacterList(list);
            }

            // Karakter Verisini Kaydet
            localStorage.setItem(dataKey, JSON.stringify(characterData));
            currentCharacterName = name;

            updateCharacterSheet(); 
            if (!isAutoSave) {
                 alert(`Karakter "${name}" baÅŸarÄ±yla kaydedildi!`);
            }

        } catch (e) {
            console.error("Karakter verileri kaydedilemedi:", e);
            if (!isAutoSave) {
                alert("Kaydetme hatasÄ±! TarayÄ±cÄ±nÄ±zÄ±n yerel depolama alanÄ± dolu veya devre dÄ±ÅŸÄ±.");
            }
        }
    }

    function loadCharacter(name) {
        const dataKey = getCharacterDataKey(name);
        try {
            const storedData = localStorage.getItem(dataKey);
            if (!storedData) {
                alert("KayÄ±tlÄ± karakter verisi bulunamadÄ±.");
                return;
            }

            const characterData = JSON.parse(storedData);
            
            if (characterData.raceBonusAppliedState) {
                raceBonusAppliedState = characterData.raceBonusAppliedState;
            } else {
                 ALL_STATS_KEYS.forEach(key => raceBonusAppliedState[key] = false);
            }

            const abilityPoolData = {};
            for (const id in characterData) {
                if (id.startsWith('abilityPool')) {
                    abilityPoolData[id] = characterData[id];
                    continue;
                }

                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = !!characterData[id];
                    } else {
                        element.value = characterData[id];
                    }
                }
            }

            currentCharacterName = name;

            showCharacterSheet(false);
            restoreAbilityPoolState(abilityPoolData);
            document.getElementById('characterListContainer').style.display = 'none';

        } catch (e) {
            console.error("Karakter verileri yÃ¼klenemedi:", e);
            alert("YÃ¼kleme hatasÄ±! KayÄ±t dosyasÄ± bozuk olabilir.");
        }
    }

    function restoreAbilityPoolState(savedSlots = {}) {
        Object.entries(savedSlots).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (!element) {
                return;
            }

            if (element.type === 'checkbox') {
                element.checked = Boolean(value);
            } else {
                element.value = value ?? '';
            }
        });
    }

    function deleteCharacter(name) {
        if (!confirm(`Karakter "${name}" kalÄ±cÄ± olarak silinecektir. Emin misiniz?`)) {
            return;
        }

        const dataKey = getCharacterDataKey(name);

        // Ana Listeden Sil
        let list = getCharacterList();
        list = list.filter(item => item !== name);
        setCharacterList(list);

        // Karakter Verisini Sil
        localStorage.removeItem(dataKey);

        // EÄŸer silinen, ÅŸu anda aÃ§Ä±k olan karakterse, sÄ±fÄ±rla
        if (currentCharacterName === name) {
            currentCharacterName = '';
            resetCharacterSheetData();
        }

        alert(`Karakter "${name}" baÅŸarÄ±yla silindi.`);
        renderCharacterList(); 
    }

    function renderCharacterList() {
        const charListElement = document.getElementById('charList');
        charListElement.innerHTML = '';
        const list = getCharacterList();

        if (list.length === 0) {
            charListElement.innerHTML = '<p style="text-align: center; color: var(--reset-button-bg);">KayÄ±tlÄ± karakter bulunmamaktadÄ±r.</p>';
            return;
        }

        list.forEach(name => {
            const listItem = document.createElement('li');
            listItem.classList.add('char-list-item');
            
            listItem.innerHTML = `
                <span>${name}</span>
                <button class="load-btn" onclick="loadCharacter('${name}')">YÃœKLE</button>
                <button class="delete-btn" onclick="deleteCharacter('${name}')">SÄ°L</button>
            `;
            charListElement.appendChild(listItem);
        });
    }

    // --- MEVCUT DÄ°ÄER FONKSÄ°YONLAR ---

    function toggleDarkMode() {
        const body = document.body;
        const toggleButton = document.getElementById('darkModeToggle');
        body.classList.toggle('dark-mode');

        if (body.classList.contains('dark-mode')) {
            toggleButton.textContent = 'â˜€ï¸ GÃ¼ndÃ¼z Modu AÃ§';
            localStorage.setItem('darkMode', 'enabled');
        } else {
            toggleButton.textContent = 'ğŸŒ™ Gece Modu AÃ§';
            localStorage.setItem('darkMode', 'disabled');
        }
    }
    
    function populateDropdowns() {
        const sinifSelect = document.getElementById('sinif');
        const irkSelect = document.getElementById('irk');

        Object.keys(CLASS_HP).forEach(sinif => {
            const option = document.createElement('option');
            option.value = sinif;
            option.textContent = sinif;
            sinifSelect.appendChild(option);
        });

        Object.keys(RACE_STAT_BONUSES).forEach(irk => {
            const option = document.createElement('option');
            option.value = irk;
            option.textContent = irk;
            irkSelect.appendChild(option);
        });
    }
    
    function updateRaceBonusDisplay(selectedRace) {
        ALL_STATS_KEYS.forEach(statKey => {
            const displaySpan = document.getElementById(statKey + '_race_bonus');
            if (displaySpan) {
                displaySpan.textContent = ''; 
            }
        });
        
        const bonuses = RACE_STAT_BONUSES[selectedRace]?.stats || {};
        
        for (const [statKey, bonusAmount] of Object.entries(bonuses)) {
            const displaySpan = document.getElementById(statKey + '_race_bonus');
            
            if (displaySpan && !raceBonusAppliedState[statKey]) {
                const sign = bonusAmount >= 0 ? '+' : '';
                displaySpan.textContent = ` (${sign}${bonusAmount} Irk Bonusu)`;
            }
        }
    }

    function clearPriorityStars() {
        const allLabels = document.querySelectorAll('label');
        allLabels.forEach(label => {
            const star = label.querySelector('.priority-star');
            if (star) {
                star.remove();
            }
        });
    }

    function getRankConfig(rankKey) {
        return RANK_SETTINGS[rankKey] || RANK_SETTINGS[DEFAULT_RANK_KEY];
    }

    function getRankDiceBonus() {
        const rankValue = document.getElementById('rutbe')?.value;
        return getRankConfig(rankValue).diceBonus;
    }

    function updateRankDependentFields() {
        const rankValue = document.getElementById('rutbe')?.value;
        const config = getRankConfig(rankValue);
        const bonusLabel = document.getElementById('rankDiceBonusLabel');
        if (bonusLabel) {
            bonusLabel.textContent = `${config.label} rÃ¼tbesi tÃ¼m zaralara +${config.diceBonus} bonus verir ve ${config.abilitySlots} yetenek slotu sunar.`;
        }
        updateAbilityPoolSlots(config.abilitySlots);
        updateAbilityTextAreaRows(config.abilitySlots);
    }

    function updateAbilityPoolSlots(slotCount) {
        const container = document.getElementById('abilityPoolSlots');
        if (!container) return;

        const previousStates = Array.from(container.querySelectorAll('.ability-slot input[type="checkbox"]')).map(cb => cb.checked);

        container.innerHTML = '';

        for (let i = 0; i < slotCount; i++) {
            const slotWrapper = document.createElement('div');
            slotWrapper.className = 'ability-slot';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `abilityPoolActive-${i + 1}`;
            checkbox.name = checkbox.id;
            checkbox.checked = !!previousStates[i];

            const label = document.createElement('label');
            label.className = 'ability-slot-label';
            label.setAttribute('for', checkbox.id);
            label.textContent = `Slot ${i + 1}`;
            slotWrapper.appendChild(checkbox);
            slotWrapper.appendChild(label);
            container.appendChild(slotWrapper);
        }
    }

    function updateAbilityTextAreaRows(slotCount) {
        const textarea = document.getElementById('yetenekler');
        if (!textarea) {
            return;
        }

        const baseRows = 6;
        const computedRows = Math.min(12, baseRows + slotCount);
        textarea.rows = computedRows;
    }

    function addPriorityStars(priorities) {
        clearPriorityStars(); 

        // Birincil istatistikleri iÅŸaretle
        priorities.forEach(statName => {
            // statName Ã¶rneÄŸin: "FÄ°ZÄ°KSEL GÃœÃ‡"
            const allLabels = document.querySelectorAll('.stat-group.three-col label');
            allLabels.forEach(label => {
                // Label iÃ§eriÄŸini al (span hariÃ§)
                let labelContent = '';
                Array.from(label.childNodes).forEach(node => {
                    if (node.nodeType === 3) { // Text node
                        labelContent += node.textContent;
                    }
                });
                labelContent = labelContent.trim();
                
                // EÄŸer label'Ä±n iÃ§eriÄŸi statName ile eÅŸleÅŸiyorsa yÄ±ldÄ±z ekle
                if (labelContent === statName) {
                    if (!label.querySelector('.priority-star')) {
                        const star = document.createElement('span');
                        star.textContent = ' *';
                        star.classList.add('priority-star');
                        label.appendChild(star);
                    }
                }
            });
        });
    }

    function updateHPBar(currentHP, maxHP) {
        const hpBar = document.getElementById('hpBar');
        if (!hpBar || maxHP === 0) {
            if (hpBar) hpBar.style.width = '0%';
            return;
        }
        
        let percent = (currentHP / maxHP) * 100;
        percent = Math.max(0, Math.min(100, percent));
        
        hpBar.style.width = `${percent}%`;

        if (percent > 50) {
            hpBar.style.backgroundColor = '#4CAF50'; 
        } else if (percent > 20) {
            hpBar.style.backgroundColor = '#ffc107'; 
        } else {
            hpBar.style.backgroundColor = '#d93025'; 
        }
    }

    function updateSkillTableBonuses() {
        const tableRows = document.querySelectorAll('#skillReferenceTable tbody tr');
        
        tableRows.forEach(row => {
            const statKey = row.getAttribute('data-stat-key');
            const bonusCell = row.querySelector('.skill-bonus');
            const bonusInput = document.getElementById(statKey + '_bonus');
            
            if (bonusInput && bonusCell) {
                bonusCell.textContent = bonusInput.value;
            }
        });
    }

    function applyRaceBonus(statKey) {
        const bonusSpan = document.getElementById(statKey + '_race_bonus');
        const valueInput = document.getElementById(statKey + '_val');
        
        const bonusText = bonusSpan.textContent; 
        if (!bonusText || bonusText.trim() === "") {
             alert("Bu istatistik iÃ§in uygulanacak bir Ä±rk bonusu bulunmuyor veya zaten uygulanmÄ±ÅŸ.");
            return;
        }

        const match = bonusText.match(/([+\-]?\d+)/);
        if (!match) return;

        const bonusAmount = parseInt(match[1]);
        let currentValue = parseInt(valueInput.value) || 0;

        currentValue += bonusAmount;
        valueInput.value = currentValue;

        calculateBonus(statKey);

        bonusSpan.textContent = '';
        raceBonusAppliedState[statKey] = true; 
        
        alert(`${statKey.toUpperCase()} istatistiÄŸine ${bonusAmount > 0 ? '+' : ''}${bonusAmount} Ä±rk bonusu baÅŸarÄ±yla eklendi!`);
    }

    function updateCharacterSheet() {
        const selectedClass = document.getElementById('sinif').value;
        const selectedRace = document.getElementById('irk').value;
        const canInput = document.getElementById('can');
        const zirhInput = document.getElementById('zirh');
        
        let maxHP = 0;
        let hpBonus = 0;
        let baseAC = 0;
        let acBonus = 0;

        if (selectedClass) {
            maxHP = CLASS_HP[selectedClass] || 0;
            baseAC = CLASS_BASE_AC[selectedClass] || 10; 
        }

        if (selectedRace && RACE_STAT_BONUSES[selectedRace]) {
            hpBonus = RACE_STAT_BONUSES[selectedRace].hp || 0;
            acBonus = RACE_STAT_BONUSES[selectedRace].ac || 0;
            
            // Irk HP bonusu ekle
            maxHP += hpBonus;
            baseAC += acBonus;
        }
        
        let finalCurrentHP = 0;
        if (maxHP > 0) {
            const hpParts = canInput.value.split('/');
            let currentHP = 0;
            
            if (hpParts.length === 2) {
                currentHP = parseInt(hpParts[0].trim()) || 0; 
            } else {
                currentHP = maxHP;
            }
            
            finalCurrentHP = Math.min(currentHP, maxHP);

            canInput.value = `${finalCurrentHP} / ${maxHP} HP`;
        } else {
            canInput.value = '--- / ---';
        }
        
        zirhInput.value = baseAC > 0 ? baseAC : '---';
        
        updateHPBar(finalCurrentHP, maxHP);

        if (selectedClass && CLASS_PRIORITIES[selectedClass]) {
            // Stat anahtarÄ±nÄ± TÃ¼rkÃ§e ada Ã§evir
            const STAT_NAME_MAP = {
                "fiziksel_guc": "FÄ°ZÄ°KSEL GÃœÃ‡",
                "dayaniklilik": "DAYANIKLILIK",
                "bilgelik": "BÄ°LGELÄ°K",
                "ceviklik": "Ã‡EVÄ°KLÄ°K",
                "zeka": "ZEKA",
                "karizma": "KARÄ°ZMA"
            };
            const primaryStatName = STAT_NAME_MAP[CLASS_PRIORITIES[selectedClass]];
            addPriorityStars([primaryStatName]);
        } else {
            clearPriorityStars();
        }
        
        updateRaceBonusDisplay(selectedRace);

        ALL_STATS_KEYS.forEach(statKey => {
            calculateBonus(statKey);
        });

        updateRankDependentFields();
    }

    function calculateBonus(statName) {
        const valueInput = document.getElementById(statName + '_val');
        const bonusInput = document.getElementById(statName + '_bonus');
        
        let statValue = parseInt(valueInput.value) || 0;
        const finalStatValue = statValue;

        let bonus = Math.floor((finalStatValue - 10) / 2);

        let bonusDisplay = bonus >= 0 ? '+' + bonus : String(bonus);
        bonusInput.value = bonusDisplay;

        updateSkillTableBonuses(); 
    }

    function rollSkillCheck(statKey, skillName) {
        const bonusInput = document.getElementById(statKey + '_bonus');
        const modal = document.getElementById('rollModal');
        const modalResult = document.getElementById('modalResult');
        const modalTitle = document.getElementById('modalTitle');
        const rollDuration = 1000; 

        const bonusText = bonusInput ? bonusInput.value : '0';
        const bonus = parseInt(bonusText) || 0;
        const rankBonus = getRankDiceBonus();
        const totalBonus = bonus + rankBonus;

        modal.style.display = 'flex';
        modalTitle.textContent = `${skillName} Yetenek KontrolÃ¼`;
        
        modalResult.classList.add('modal-rolling');
        modalResult.textContent = 'Zar AtÄ±lÄ±yor...';
        modalResult.style.color = 'white';
        modalResult.style.backgroundColor = 'transparent';

        const animationInterval = setInterval(() => {
            modalResult.textContent = Math.floor(Math.random() * 20) + 1;
        }, 50); 

        setTimeout(() => {
            clearInterval(animationInterval); 

            const d20Roll = Math.floor(Math.random() * 20) + 1;
            const totalResult = d20Roll + totalBonus;
            
            modalResult.classList.remove('modal-rolling');

            // STAT_MAP'i bu fonksiyonda manuel olarak tekrar tanÄ±mlÄ±yoruz
            const STAT_MAP_REVERSE = {
                "fiziksel_guc": "FÄ°ZÄ°KSEL GÃœÃ‡", 
                "dayaniklilik": "DAYANIKLILIK", 
                "bilgelik": "BÄ°LGELÄ°K", 
                "ceviklik": "Ã‡EVÄ°KLÄ°K", 
                "zeka": "ZEKA", 
                "karizma": "KARÄ°ZMA"
            };
            const statNameTR = STAT_MAP_REVERSE[statKey];

            let breakdown = `(Zar: ${d20Roll} ${bonus >= 0 ? '+' : ''}${bonus} ${statNameTR} Bonusu ${rankBonus >= 0 ? '+' : ''}${rankBonus} RÃ¼tbe Bonusu)`;
            modalTitle.textContent = `${skillName}: ${breakdown}`;

            if (d20Roll === 20) {
                modalResult.style.color = '#76ff03'; 
                modalResult.textContent = `KRÄ°TÄ°K BAÅARI! (${totalResult})`;
            } else if (d20Roll === 1) {
                modalResult.style.color = '#ff1744'; 
                modalResult.textContent = `KRÄ°TÄ°K HATA! (${totalResult})`;
            } else {
                modalResult.style.color = 'white'; 
                modalResult.textContent = totalResult;
            }

            document.getElementById('diceResult').textContent = `Son Yetenek KontrolÃ¼: ${totalResult}`;

        }, rollDuration); 
    }
    
    function rollBaseAttack() {
        const selectedClass = document.getElementById('sinif').value;
        
        if (!selectedClass || selectedClass === "") {
            alert("LÃ¼tfen Ã¶nce karakterin sÄ±nÄ±fÄ±nÄ± seÃ§in.");
            return;
        }

        // CLASS_PRIORITIES'teki deÄŸer artÄ±k direkt stat anahtarÄ±
        const primaryStatKey = CLASS_PRIORITIES[selectedClass];

        if (!primaryStatKey) {
            alert("SeÃ§ilen sÄ±nÄ±f iÃ§in tanÄ±mlanmÄ±ÅŸ bir Birincil Ä°statistik bulunamadÄ±.");
            return;
        }

        // Stat anahtarÄ±nÄ± TÃ¼rkÃ§e ada Ã§evir
        const STAT_NAME_MAP = {
            "fiziksel_guc": "FÄ°ZÄ°KSEL GÃœÃ‡",
            "dayaniklilik": "DAYANIKLILIK",
            "bilgelik": "BÄ°LGELÄ°K",
            "ceviklik": "Ã‡EVÄ°KLÄ°K",
            "zeka": "ZEKA",
            "karizma": "KARÄ°ZMA"
        };
        const primaryStatTR = STAT_NAME_MAP[primaryStatKey];

        const bonusInput = document.getElementById(primaryStatKey + '_bonus');
        const statBonus = parseInt(bonusInput ? bonusInput.value : 0) || 0;
        const rankBonus = getRankDiceBonus();
        
        const modal = document.getElementById('rollModal');
        const modalResult = document.getElementById('modalResult');
        const modalTitle = document.getElementById('modalTitle');
        const rollDuration = 1000; 
        
        // Zar atma Ã¶ncesinde hesapla
        const d6Rolls = [];
        for (let i = 0; i < 3; i++) {
            d6Rolls.push(Math.floor(Math.random() * 6) + 1);
        }
        const totalRoll = d6Rolls.reduce((a, b) => a + b, 0);
        const totalDamage = totalRoll + statBonus + rankBonus;
        
        modal.style.display = 'flex';
        modalTitle.textContent = `Temel SaldÄ±rÄ± (3D6 + ${primaryStatTR})`;
        
        modalResult.classList.add('modal-rolling');
        modalResult.textContent = 'Hasar HesaplanÄ±yor...';
        modalResult.style.color = 'white';
        modalResult.style.backgroundColor = 'transparent';

        const animationInterval = setInterval(() => {
            // Animasyon sÄ±rasÄ±nda rastgele toplam gÃ¶ster
        modalResult.textContent = Math.floor(Math.random() * 18) + 1 + statBonus + rankBonus;
        }, 50); 

        setTimeout(() => {
            clearInterval(animationInterval); 
            
            modalResult.classList.remove('modal-rolling');

            const breakdown = `(${d6Rolls.join(' + ')} Zar + ${statBonus >= 0 ? '+' : ''}${statBonus} ${primaryStatTR} Bonusu ${rankBonus >= 0 ? '+' : ''}${rankBonus} RÃ¼tbe Bonusu)`;
            
            modalTitle.textContent = `Temel Hasar: ${breakdown}`;
            modalResult.textContent = totalDamage;
            modalResult.style.color = '#fffae6'; 
            modalResult.style.backgroundColor = '#d93025'; 
            
            document.getElementById('diceResult').textContent = `Son SaldÄ±rÄ± HasarÄ±: ${totalDamage}`;

        }, rollDuration); 
    }

    function rollMultipleDice(sides) {
        const countInput = document.getElementById(`diceCount-${sides}`);
        const count = Math.max(1, parseInt(countInput?.value) || 1);
        const rolls = [];
        for (let i = 0; i < count; i++) {
            rolls.push(Math.floor(Math.random() * sides) + 1);
        }

        const totalRoll = rolls.reduce((acc, curr) => acc + curr, 0);
        const rankBonus = getRankDiceBonus();
        const totalResult = totalRoll + rankBonus;

        const modal = document.getElementById('rollModal');
        const modalResult = document.getElementById('modalResult');
        const modalTitle = document.getElementById('modalTitle');
        const rollDuration = 1000;

        modal.style.display = 'flex';
        modalTitle.textContent = `D${sides} x${count} AtÄ±ÅŸÄ±`;
        
        modalResult.classList.add('modal-rolling');
        modalResult.textContent = 'Zar AtÄ±lÄ±yor...';
        modalResult.style.color = 'white';
        modalResult.style.backgroundColor = 'transparent';

        const animationInterval = setInterval(() => {
            modalResult.textContent = Math.floor(Math.random() * sides) + 1;
        }, 50); 

        setTimeout(() => {
            clearInterval(animationInterval); 
            modalResult.classList.remove('modal-rolling');

            const rankBonusLabel = rankBonus >= 0 ? `+${rankBonus}` : `${rankBonus}`;
            const breakdown = `(${rolls.join(' + ')} Zar + ${rankBonusLabel} RÃ¼tbe Bonusu)`;
            modalTitle.textContent = `Toplam: ${breakdown}`;
            modalResult.textContent = totalResult;
            modalResult.style.color = '#ffc107';
            modalResult.style.backgroundColor = '#222';
            document.getElementById('diceResult').textContent = `Son D${sides} AtÄ±ÅŸÄ±: ${totalResult}`;

        }, rollDuration); 
    }
    
    function updateHP(amount, operation) {
        const canInput = document.getElementById('can');
        const valueInput = document.getElementById('hpValueInput');
        
        let amountToChange = parseInt(valueInput.value) || 0;
        
        const hpParts = canInput.value.split('/');
        let currentHP = parseInt(hpParts[0].trim()) || 0;
        const maxHP = parseInt(hpParts[1].trim()) || 0;

        if (maxHP === 0) {
            alert("Ã–nce sÄ±nÄ±f ve Ä±rk seÃ§erek Maksimum CanÄ± (Max HP) belirleyin.");
            return;
        }

        if ((operation === 'damage' || operation === 'heal') && amountToChange === 0) {
            alert("LÃ¼tfen Hasar/Ä°yileÅŸtirme iÃ§in bir deÄŸer girin.");
            return;
        }

        if (operation === 'damage') {
            currentHP = Math.max(0, currentHP - amountToChange);
        } else if (operation === 'heal') {
            currentHP = Math.min(maxHP, currentHP + amountToChange);
        } else if (operation === 'shortRest') {
            const healAmount = Math.ceil(maxHP / 2);
            currentHP = Math.min(maxHP, currentHP + healAmount);
            alert(`KÄ±sa Dinlenme: ${healAmount} HP iyileÅŸtirildi.`);
        } else if (operation === 'longRest') {
            currentHP = maxHP;
            alert("Uzun Dinlenme: Can tam olarak yenilendi.");
        }

        canInput.value = `${currentHP} / ${maxHP} HP`;
        updateHPBar(currentHP, maxHP); 

        if (operation === 'damage' || operation === 'heal') {
            valueInput.value = ''; 
        }
    }

    // --- BAÅLANGIÃ‡ YÃœKLEME VE EVENT LISTENER'LAR ---

    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkModeToggle').textContent = 'â˜€ï¸ GÃ¼ndÃ¼z Modu AÃ§';
        }

        populateDropdowns();
        updateRankDependentFields();
        
        // Uygulama her zaman Ana MenÃ¼ ile baÅŸlar
        showMainMenu();
    });

    document.getElementById('damageButton').addEventListener('click', () => updateHP(0, 'damage'));
    document.getElementById('healButton').addEventListener('click', () => updateHP(0, 'heal'));
    document.getElementById('shortRestButton').addEventListener('click', () => updateHP(0, 'shortRest'));
    document.getElementById('longRestButton').addEventListener('click', () => updateHP(0, 'longRest'));
    const rankSelect = document.getElementById('rutbe');
    if (rankSelect) {
        rankSelect.addEventListener('change', updateRankDependentFields);
    }

    document.getElementById('rollButton').addEventListener('click', function() {
        // Mevcut dÃ¼z D20 atÄ±ÅŸÄ± iÅŸlevi
        const modal = document.getElementById('rollModal');
        const modalResult = document.getElementById('modalResult');
        const modalTitle = document.getElementById('modalTitle');
        const rollDuration = 1000;

        modal.style.display = 'flex';
        modalTitle.textContent = `DÃ¼z D20 Zar AtÄ±ÅŸÄ±`;
        
        modalResult.classList.add('modal-rolling');
        modalResult.textContent = 'Zar AtÄ±lÄ±yor...';
        modalResult.style.color = 'white';
        modalResult.style.backgroundColor = 'transparent';

        const animationInterval = setInterval(() => {
            modalResult.textContent = Math.floor(Math.random() * 20) + 1;
        }, 50); 

        setTimeout(() => {
            clearInterval(animationInterval); 
            const result = Math.floor(Math.random() * 20) + 1;
            const rankBonus = getRankDiceBonus();
            const totalResult = result + rankBonus;
            const rankBonusLabel = rankBonus >= 0 ? `+${rankBonus}` : `${rankBonus}`;
            
            modalResult.classList.remove('modal-rolling');
            modalTitle.textContent = `DÃ¼z D20 Sonucu (Zar: ${result} ${rankBonusLabel} RÃ¼tbe Bonusu)`;
            
            if (result === 20) {
                modalResult.style.color = '#76ff03';
                modalResult.textContent = `KRÄ°TÄ°K BAÅARI! (${totalResult})`;
            } else if (result === 1) {
                modalResult.style.color = '#ff1744'; 
                modalResult.textContent = `KRÄ°TÄ°K HATA! (${totalResult})`;
            } else {
                modalResult.style.color = 'white'; 
                modalResult.textContent = totalResult;
            }
            modalResult.style.backgroundColor = 'transparent';
             document.getElementById('diceResult').textContent = `Son D20 AtÄ±ÅŸÄ±: ${totalResult}`;

        }, rollDuration); 
    });

    document.querySelectorAll('.multi-dice-btn').forEach(btn => {
        const sides = parseInt(btn.dataset.dice, 10);
        if (isNaN(sides)) {
            return;
        }
        btn.addEventListener('click', () => rollMultipleDice(sides));
    });

    document.getElementById('baseAttackButton').addEventListener('click', rollBaseAttack); // YENÄ° EKLENEN BUTON EVENTI

    document.getElementById('rollModal').addEventListener('click', function(event) {
        if (event.target.id === 'rollModal' || event.target.id === 'modalResult') {
            this.style.display = 'none';
        }
    });

</script>

</body>
</html>